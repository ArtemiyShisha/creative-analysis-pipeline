# Creative Regeneration — Design Document

**Дата:** 2026-02-09
**Статус:** Approved
**Версия:** 1.0

---

## Цель

Добавить в пайплайн автоматическую генерацию улучшенного варианта баннера на основе рекомендаций анализа. Результат — визуальный AI-концепт для вдохновения дизайнера, а не финальный продакшн-креатив.

## Архитектура

К существующему пайплайну (9 шагов) добавляются 2 новых шага:

```
[Существующий пайплайн: шаги 1-9]
        |
   results (zones, recommendations, heatmap)
        |
[Step 10] GPT-5.2 -> Промпт-инженер
   Input:  recommendations + zones + описание изображения
   Output: структурированный промпт для GPT Image edit
        |
[Step 11] GPT Image (gpt-image-1) -> Edit
   Input:  исходное изображение + промпт из Step 10
   Output: улучшенный баннер (JPG)
        |
   Результат: оригинал + улучшенный вариант
```

Генерация — **опциональный** шаг. Анализ работает как раньше без изменений.

## Step 10: Промпт-инженер (GPT-5.2)

### Задача

Превратить рекомендации (написанные для человека) в техническое задание для GPT Image edit. Это разные тексты:
- Рекомендация: "Усилить CTA-кнопку"
- Промпт для модели: "Make the black button at coordinates [60, 310] 40% larger, increase contrast with white text"

### Input

- `recommendations` — список рекомендаций с приоритетами
- `zones` — зоны с bbox-координатами и attention %
- Размер и описание изображения

### Output

```python
{
    "edit_prompt": "...",        # Основной промпт для GPT Image edit
    "focus_areas": [             # Какие зоны затрагиваются
        {"zone": "cta", "action": "enlarge and increase contrast"},
        {"zone": "header", "action": "reposition to upper-left"}
    ],
    "preserve": [                # Что НЕ трогать
        "logo style and position",
        "brand color palette",
        "product image"
    ],
    "style_notes": "..."        # Указания по сохранению стиля
}
```

### Фильтрация рекомендаций

Берутся только рекомендации с приоритетом **High** и **Medium**. Low пропускаются — мелкие правки могут испортить общее впечатление.

### Ключевой принцип

Промпт должен явно указывать что **сохранить** (бренд, стиль, цвета), а не только что менять.

## Step 11: Генерация (GPT Image edit)

### API-вызов

```python
response = requests.post(
    "https://api.openai.com/v1/images/edits",
    headers={"Authorization": f"Bearer {API_KEY}"},
    files={"image": open(image_path, "rb")},
    data={
        "model": "gpt-image-1",
        "prompt": edit_prompt,
        "size": "1024x1024",
        "quality": "high"
    }
)
```

### Обработка размеров

GPT Image поддерживает фиксированные размеры (1024x1024, 1536x1024, 1024x1536). Выбираем ближайший к пропорциям оригинала. После генерации — ресайзим обратно к оригинальному размеру.

### Выходные файлы

- `{name}_improved.jpg` — улучшенный баннер
- Существующие файлы (`_final.json`, `_heatmap.jpg`) не меняются

### Стоимость

~$0.04-0.13 за генерацию (GPT-5.2 промпт + GPT Image). Итого весь пайплайн с генерацией: ~$0.08-0.23 за креатив.

## Интеграция

### CLI

```bash
# Только анализ (как сейчас)
python analyze_creative_final.py data/yandex_pay.png

# Анализ + генерация улучшенного варианта
python analyze_creative_final.py data/yandex_pay.png --regenerate
```

С `--regenerate` сохраняет `{name}_improved.jpg` как отдельный файл. Полная обратная совместимость — без флага ничего не меняется.

### Web UI (Streamlit)

```
Загрузка -> Анализировать -> [Оценка, таблица, heatmap, рекомендации]
                                    |
                          Скачать PDF (анализ, как сейчас)
                                    |
                          Кнопка "Сгенерировать улучшенный вариант"
                                    |
                          [Оригинал | Улучшенный] side-by-side
                                    |
                          Скачать JPG (только улучшенный баннер)
```

- PDF (анализ + рекомендации) скачивается отдельно, как сейчас
- JPG (улучшенный баннер) скачивается отдельно
- Кнопка генерации отделена от анализа — пользователь сначала читает рекомендации

## Обработка ошибок

| Ошибка | Действие |
|--------|----------|
| Content policy rejection | "Не удалось сгенерировать — модель отклонила запрос. Используйте рекомендации для ручной доработки." |
| Timeout / 5xx | Одна повторная попытка, затем сообщение |
| Billing / 429 | Сообщение о недостаточности средств |

Дисклеймер под картинкой: "AI-концепт для вдохновения. Может содержать неточности в тексте и деталях бренда."

## Что НЕ делаем (YAGNI)

- Не перезапускаем анализ на сгенерированном баннере
- Не даём выбирать какие рекомендации применять
- Не генерируем несколько вариантов
- Не добавляем маски/inpainting

## Реализация

### Новые функции в analyze_creative_final.py

1. `build_edit_prompt(zones, recommendations)` — Step 10, GPT-5.2 промпт-инженер
2. `regenerate_creative(image_path, edit_prompt)` — Step 11, GPT Image edit
3. Обновить `analyze_creative_final()` — опциональный вызов шагов 10-11
4. Обновить `if __name__ == "__main__"` — парсинг `--regenerate`

### Изменения в app.py

1. Кнопка "Сгенерировать улучшенный вариант" после результатов анализа
2. Side-by-side отображение (st.columns)
3. Кнопка скачивания JPG (st.download_button)
4. Обработка ошибок генерации

### Технические решения

| Решение | Выбор |
|---------|-------|
| Image model | GPT Image (gpt-image-1) edit mode |
| Промпт-инженер | GPT-5.2 с reasoning_effort='medium' |
| Интеграция | CLI `--regenerate` + кнопка в Web UI |
| Скачивание | PDF (анализ) отдельно, JPG (баннер) отдельно |
| Фильтр рекомендаций | High + Medium, Low пропускаются |
